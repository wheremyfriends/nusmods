{"version":3,"file":"assets/export.2030fda6.js","mappings":"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","sources":["webpack:///./data/academic-calendar.ts","webpack:///./utils/ical.ts"],"sourcesContent":["import academicCalendarJSON from './academic-calendar.json';\r\n\r\n// Force TS to accept our typing instead of inferring from the JSON\r\ntype DateTuple = [number, number, number];\r\nconst academicCalendar = academicCalendarJSON as unknown as {\r\n  [year: string]: {\r\n    [semester: string]: { start: DateTuple };\r\n  };\r\n};\r\n\r\nexport default academicCalendar;\r\n","import _ from 'lodash';\r\nimport type { EventOption } from 'ical-generator';\r\nimport { addDays, addMinutes, addWeeks, isValid } from 'date-fns';\r\n\r\nimport {\r\n  consumeWeeks,\r\n  EndTime,\r\n  LessonTime,\r\n  Module,\r\n  NumericWeeks,\r\n  RawLesson,\r\n  Semester,\r\n  StartTime,\r\n  WeekRange,\r\n} from 'types/modules';\r\nimport { SemTimetableConfigWithLessons } from 'types/timetables';\r\n\r\nimport config from 'config';\r\nimport academicCalendar from 'data/academic-calendar';\r\nimport { getExamDate, getExamDuration } from 'utils/modules';\r\nimport { getLessonTimeHours, getLessonTimeMinutes, parseDate } from './timify';\r\n\r\nconst SG_UTC_TIME_DIFF_MS = 8 * 60 * 60 * 1000;\r\nexport const RECESS_WEEK = -1;\r\nconst NUM_WEEKS_IN_A_SEM = 14; // including reading week\r\nconst ODD_WEEKS = [1, 3, 5, 7, 9, 11, 13];\r\nconst EVEN_WEEKS = [2, 4, 6, 8, 10, 12];\r\nconst ALL_WEEKS = [...ODD_WEEKS, ...EVEN_WEEKS];\r\nconst DEFAULT_EXAM_DURATION = 120; // If not provided, assume exams are 2 hours long\r\n\r\nfunction dayIndex(weekday: string) {\r\n  return ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].indexOf(weekday.toLowerCase());\r\n}\r\n\r\n/**\r\n * Parse out the hour component from a time string in the format of hhmm\r\n */\r\nexport function getTimeHour(time: LessonTime) {\r\n  return getLessonTimeHours(time) + getLessonTimeMinutes(time) / 60;\r\n}\r\n\r\nfunction addLessonOffset(date: Date, hourOffset: number): Date {\r\n  return addMinutes(date, hourOffset * 60);\r\n}\r\n\r\nexport function iCalEventForExam(module: Module, semester: Semester): EventOption | null {\r\n  const examDate = getExamDate(module, semester);\r\n  if (!examDate) return null;\r\n\r\n  const start = new Date(examDate);\r\n  if (!isValid(start)) return null;\r\n\r\n  return {\r\n    start,\r\n    end: addMinutes(start, getExamDuration(module, semester) || DEFAULT_EXAM_DURATION),\r\n    summary: `${module.moduleCode} Exam`,\r\n    description: module.title,\r\n  };\r\n}\r\n\r\nexport function holidaysForYear(hourOffset = 0): Date[] {\r\n  return config.holidays\r\n    .map((date) => new Date(date.valueOf() - SG_UTC_TIME_DIFF_MS)) // Convert to local time\r\n    .map((holiday) => addLessonOffset(holiday, hourOffset));\r\n}\r\n\r\n// given academic weeks in semester and a start date in week 1,\r\n// return dates corresponding to the respective weeks\r\nexport function datesForAcademicWeeks(start: Date, week: number): Date {\r\n  // all weeks 7 and after are bumped by 7 days because of recess week\r\n  if (week === RECESS_WEEK) {\r\n    return addWeeks(start, 6);\r\n  }\r\n  return addWeeks(start, week <= 6 ? week - 1 : week);\r\n}\r\n\r\nfunction calculateStartEnd(date: Date, startTime: StartTime, endTime: EndTime) {\r\n  const start = addLessonOffset(date, getTimeHour(startTime));\r\n  const end = addLessonOffset(date, getTimeHour(endTime));\r\n\r\n  return { start, end };\r\n}\r\n\r\nexport function calculateNumericWeek(\r\n  lesson: RawLesson,\r\n  _semester: Semester,\r\n  weeks: NumericWeeks,\r\n  firstDayOfSchool: Date,\r\n): EventOption {\r\n  const lessonDay = addDays(firstDayOfSchool, dayIndex(lesson.day));\r\n  const { start, end } = calculateStartEnd(lessonDay, lesson.startTime, lesson.endTime);\r\n  const excludedWeeks = _.difference([RECESS_WEEK, ...ALL_WEEKS], weeks);\r\n\r\n  return {\r\n    start,\r\n    end,\r\n    repeating: {\r\n      freq: 'WEEKLY',\r\n      count: NUM_WEEKS_IN_A_SEM,\r\n      byDay: [lesson.day.slice(0, 2)],\r\n      exclude: [\r\n        ...excludedWeeks.map((week) => datesForAcademicWeeks(start, week)),\r\n        ...holidaysForYear(getTimeHour(lesson.startTime)),\r\n      ],\r\n    },\r\n  };\r\n}\r\n\r\nexport function calculateWeekRange(\r\n  lesson: RawLesson,\r\n  _semester: Semester,\r\n  weekRange: WeekRange,\r\n): EventOption {\r\n  const rangeStart = parseDate(weekRange.start);\r\n  const rangeEnd = parseDate(weekRange.end);\r\n  const { start, end } = calculateStartEnd(rangeStart, lesson.startTime, lesson.endTime);\r\n\r\n  const interval = weekRange.weekInterval || 1;\r\n  const exclusions = [];\r\n\r\n  if (weekRange.weeks) {\r\n    for (\r\n      let current = rangeStart, weekNumber = 1;\r\n      current <= rangeEnd;\r\n      current = addWeeks(current, interval), weekNumber += interval\r\n    ) {\r\n      if (!weekRange.weeks.includes(weekNumber)) {\r\n        const lessonTime = calculateStartEnd(current, lesson.startTime, lesson.endTime);\r\n        exclusions.push(lessonTime.start);\r\n      }\r\n    }\r\n  }\r\n\r\n  const lastLesson = calculateStartEnd(rangeEnd, lesson.startTime, lesson.endTime);\r\n\r\n  return {\r\n    start,\r\n    end,\r\n    repeating: {\r\n      interval,\r\n      freq: 'WEEKLY',\r\n      until: lastLesson.end,\r\n      byDay: [lesson.day.slice(0, 2)],\r\n      exclude: [...exclusions, ...holidaysForYear(getTimeHour(lesson.startTime))],\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Strategy is to generate a weekly event,\r\n * then calculate exclusion for special cases in calculateExclusion.\r\n */\r\nexport function iCalEventForLesson(\r\n  lesson: RawLesson,\r\n  module: Module,\r\n  semester: Semester,\r\n  firstDayOfSchool: Date,\r\n): EventOption {\r\n  const event = consumeWeeks(\r\n    lesson.weeks,\r\n    (weeks) => calculateNumericWeek(lesson, semester, weeks, firstDayOfSchool),\r\n    (weeks) => calculateWeekRange(lesson, semester, weeks),\r\n  );\r\n\r\n  return {\r\n    ...event,\r\n    summary: `${module.moduleCode} ${lesson.lessonType}`,\r\n    description: `${module.title}\\n${lesson.lessonType} Group ${lesson.classNo}`,\r\n    location: lesson.venue,\r\n  };\r\n}\r\n\r\nexport default function iCalForTimetable(\r\n  semester: Semester,\r\n  timetable: SemTimetableConfigWithLessons,\r\n  moduleData: { [moduleCode: string]: Module },\r\n  hiddenModules: string[],\r\n  academicYear: string = config.academicYear,\r\n): EventOption[] {\r\n  const [year, month, day] = academicCalendar[academicYear][semester].start;\r\n  // 'month - 1' because JS months are zero indexed\r\n  const firstDayOfSchool = new Date(Date.UTC(year, month - 1, day) - SG_UTC_TIME_DIFF_MS);\r\n  const events: EventOption[] = [];\r\n\r\n  _.each(timetable, (lessonConfig, moduleCode) => {\r\n    if (hiddenModules.includes(moduleCode)) return;\r\n\r\n    _.each(lessonConfig, (lessons) => {\r\n      lessons.forEach((lesson) => {\r\n        events.push(iCalEventForLesson(lesson, moduleData[moduleCode], semester, firstDayOfSchool));\r\n      });\r\n    });\r\n\r\n    const examEvent = iCalEventForExam(moduleData[moduleCode], semester);\r\n    if (examEvent) events.push(examEvent);\r\n  });\r\n\r\n  return events;\r\n}\r\n"],"names":["academicCalendarJSON","academicCalendar","addDays","addMinutes","addWeeks","isValid","consumeWeeks","config","getExamDate","getExamDuration","getLessonTimeHours","getLessonTimeMinutes","parseDate","SG_UTC_TIME_DIFF_MS","RECESS_WEEK","NUM_WEEKS_IN_A_SEM","ODD_WEEKS","EVEN_WEEKS","ALL_WEEKS","DEFAULT_EXAM_DURATION","dayIndex","weekday","indexOf","toLowerCase","getTimeHour","time","addLessonOffset","date","hourOffset","iCalEventForExam","module","semester","examDate","start","Date","end","summary","concat","moduleCode","description","title","holidaysForYear","arguments","length","undefined","holidays","map","valueOf","holiday","datesForAcademicWeeks","week","calculateStartEnd","startTime","endTime","calculateNumericWeek","lesson","_semester","weeks","firstDayOfSchool","lessonDay","day","excludedWeeks","_difference","repeating","freq","count","byDay","slice","exclude","calculateWeekRange","weekRange","rangeStart","rangeEnd","interval","weekInterval","exclusions","current","weekNumber","includes","lessonTime","push","lastLesson","until","iCalEventForLesson","event","_objectSpread","lessonType","classNo","location","venue","iCalForTimetable","timetable","moduleData","hiddenModules","academicYear","year","month","UTC","events","_each","lessonConfig","lessons","forEach","examEvent"],"sourceRoot":""}